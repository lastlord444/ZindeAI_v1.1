name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate-db:
    runs-on: ubuntu-latest

    env:
      SUPABASE_DB_PASSWORD: "files_ci_test_password"

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Git Config & Fetch
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --no-tags origin main:refs/remotes/origin/main || git fetch origin main
          git rev-parse --is-inside-work-tree
          git show -s --oneline

      - name: Guard Migration Encoding
        run: |
          # Fail if any SQL file contains NUL bytes (UTF-16 detection)
          if grep -rP '\x00' supabase/migrations/*.sql; then
            echo "FAIL: Migration files contain NUL bytes (likely UTF-16). Please save as UTF-8."
            exit 1
          fi
          echo "PASS: No encoding issues detected."

      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - uses: supabase/setup-cli@v1
        with:
          version: 2.70.5

      - name: Contract Check (AJV)
        run: |
          cd tools/contract-check
          # install dependencies inline or check if package-lock is committed?
          # Assuming we install fresh for check
          npm install
          node check.js

      - name: Start Supabase (Local)
        run: supabase start

      - name: Wait for DB
        run: sleep 10




      - name: Reset DB (Applying Migrations & Seeds)
        run: printf "y\n" | supabase db reset

      - name: Run Data Validators (Phase 1.5)
        env:
           DATABASE_URL: "postgres://postgres:postgres@localhost:54322/postgres"
        run: |
           # Running Seed Validator (Hard Gate)
           deno run -A --unstable tools/validators/seed_validator.ts
           # Run Plan Validator (Fixture Check)
           deno run -A --unstable tools/validators/plan_validator.ts
           
      - name: Sync Engine -> Edge (Enforce)
        run: |
          # Ensure engine is synced to edge, fail if git diff is produced
          deno run -A tools/sync-engine-to-edge.ts
          git diff --exit-code


      - name: Run Seed Validation
        env:
          DATABASE_URL: "postgres://postgres:postgres@localhost:54322/postgres"
        run: |
          deno run -A tests/seed/validate_seeds.ts

      - name: Run Plan Validation (Example)
        run: |
          # Create a dummy plan to test the validator
          echo '{"name":"Test Plan","items":[{"day_of_week":1,"meal_type":"kahvalti","meal_id":"00000000-0000-0000-0000-000000000000","name":"Firik"}]}' > dummy_plan.json
          deno run -A tests/plan/validate_plan.ts dummy_plan.json

      - name: Run Engine Tests (Deno)
        run: |
          cd engine
          # We need to run tests relative to engine directory or adjust imports
          deno test --allow-env tests/

      - name: Run Service Layer Tests
        run: |
          deno test --allow-env --allow-net tests/service/

      - name: Export Supabase Keys
        run: |
          supabase status -o json | tee status.json
          cat status.json
          ANON=$(jq -r '.anon_key // .ANON_KEY // .keys.anon_key // .keys.ANON_KEY // .api.anon_key // .api.ANON_KEY // empty' status.json)
          echo "SUPABASE_ANON_KEY=$ANON" >> $GITHUB_ENV
          echo "ANON_KEY=$ANON" >> $GITHUB_ENV
          echo "SUPABASE_URL=http://127.0.0.1:54321" >> $GITHUB_ENV
          echo "API_URL=http://127.0.0.1:54321" >> $GITHUB_ENV
          test -n "$ANON" || (echo "anon_key missing" && exit 1)

      - name: Smoke Test (Edge Function)
        run: |
          # Use Deno to run smoke test script
          # Env vars SUPABASE_ANON_KEY and SUPABASE_URL are now available globally
          deno run --allow-net=127.0.0.1:54321 --allow-read=contracts/v1,tools/smoke,supabase/functions/generate-plan/schema --allow-env=SUPABASE_URL,SUPABASE_ANON_KEY,API_URL,ANON_KEY tools/smoke/generate-plan.ts

      - name: Verify No Mock Usage
        run: |
           if grep -r "mockMeals" supabase/functions/generate-plan/index.ts; then
             echo "FAIL: mockMeals usage found in generate-plan/index.ts"
             exit 1
           fi
           echo "PASS: No mockMeals usage found."

      - name: Dump Edge Runtime logs (on smoke failure)
        if: failure()
        continue-on-error: true
        run: |
          echo "== docker ps =="
          docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"

          echo "== guess edge runtime containers =="
          docker ps --format "{{.Names}}" | grep -Ei "edge|runtime|functions|supabase" || true

          echo "== edge runtime logs (tail) =="
          for c in $(docker ps --format "{{.Names}}" | grep -Ei "edge|runtime|functions"); do
            echo "----- logs: $c -----"
            docker logs "$c" --tail 300 || true
          done


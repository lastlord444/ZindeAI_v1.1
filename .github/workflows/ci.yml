name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate-db:
    runs-on: ubuntu-latest

    env:
      SUPABASE_DB_PASSWORD: "files_ci_test_password"

    steps:
      - uses: actions/checkout@v3

      - uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - uses: supabase/setup-cli@v1
        with:
          version: 2.70.5

      - name: Contract Check (AJV)
        run: |
          cd tools/contract-check
          # install dependencies inline or check if package-lock is committed?
          # Assuming we install fresh for check
          npm install
          node check.js

      - name: Start Supabase (Local)
        run: supabase start

      - name: Wait for DB
        run: sleep 10

      - name: Export Supabase Keys
        run: |
          supabase status -o json > status.json
          echo "SUPABASE_ANON_KEY=$(jq -r .anon_key status.json)" >> $GITHUB_ENV
          echo "SUPABASE_URL=$(jq -r .api_url status.json)" >> $GITHUB_ENV

      - name: Smoke Test (Edge Function)
        run: |
          # Use Deno to run smoke test script
          # Env vars SUPABASE_ANON_KEY and SUPABASE_URL are now available globally
          deno run --allow-net --allow-env tools/smoke/generate-plan.ts

      - name: Reset DB (Applying Migrations & Seeds)
        run: printf "y\n" | supabase db reset

      - name: Run Seed Validation
        env:
          DATABASE_URL: "postgres://postgres:postgres@localhost:54322/postgres"
        run: |
          deno run -A tests/seed/validate_seeds.ts

      - name: Run Plan Validation (Example)
        run: |
          # Create a dummy plan to test the validator
          echo '{"name":"Test Plan","items":[{"day_of_week":1,"meal_type":"kahvalti","meal_id":"00000000-0000-0000-0000-000000000000","name":"Firik"}]}' > dummy_plan.json
          deno run -A tests/plan/validate_plan.ts dummy_plan.json

      - name: Run Engine Tests (Deno)
        run: |
          cd engine
          # We need to run tests relative to engine directory or adjust imports
          deno test --allow-env tests/
